=========================================================================================================================
[‚úÖTEORIA ENTENDIMIENTO]:

‚úÖ tipos de capas del modelo OSI y su funci√≥n principa:
******************************************************************
+-------+----------------------+----------------------------------------+
| Capa  | Nombre               | Funci√≥n                                |
+-------+----------------------+----------------------------------------+
| 7     | Aplicaci√≥n           | Interfaz usuario y aplicaciones        |
| 6     | Presentaci√≥n         | Formato, cifrado y compresi√≥n          |
| 5     | Sesi√≥n               | Control de di√°logo y sesiones          |
| 4     | Transporte           | Transporte fiable y control de errores |
| 3     | Red                  | Enrutamiento y direccionamiento        |
| 2     | Enlace de Datos      | Comunicaci√≥n nodo a nodo, MAC          |
| 1     | F√≠sica               | Transmisi√≥n de bits f√≠sicos            |
+-------+----------------------+----------------------------------------+

‚úÖ protocolos principales de redes:
******************************************************************
+------------+-------------------------+---------------------------------------------------+
| Protocolo  | Capa OSI / TCP-IP       | Funci√≥n                                           |
+------------+-------------------------+---------------------------------------------------+
| IP         | Capa 3 (Red)            | Encaminamiento y direccionamiento                 |
| ICMP       | Capa 3 (Red)            | Mensajes de control y error (ping, traceroute)    |
| TCP        | Capa 4 (Transporte)     | Transporte confiable, conexi√≥n orientada          |
| UDP        | Capa 4 (Transporte)     | Transporte no confiable, sin conexi√≥n             |
| ARP        | Capa 2/3 (Enlace/Red)   | Resoluci√≥n de direcciones IP a MAC                |
| HTTP       | Capa 7 (Aplicaci√≥n)     | Protocolo web, transferencia de hipertexto        |
| HTTPS      | Capa 7 (Aplicaci√≥n)     | HTTP sobre TLS/SSL, comunicaci√≥n segura           |
| FTP        | Capa 7 (Aplicaci√≥n)     | Transferencia de archivos                         |
| SMTP       | Capa 7 (Aplicaci√≥n)     | Env√≠o de correo electr√≥nico                       |
| DNS        | Capa 7 (Aplicaci√≥n)     | Resoluci√≥n de nombres de dominio                  |
| DHCP       | Capa 7 (Aplicaci√≥n)     | Asignaci√≥n autom√°tica de IP                       |
| SSH        | Capa 7 (Aplicaci√≥n)     | Acceso remoto seguro                              |
| SNMP       | Capa 7 (Aplicaci√≥n)     | Gesti√≥n y monitorizaci√≥n de dispositivos          |
| TLS/SSL    | Capa 6/7 (Presentaci√≥n) | Cifrado y seguridad en comunicaciones             |
| RTP        | Capa 7 (Aplicaci√≥n)     | Transporte de datos en tiempo real (VoIP, video)  |
+------------+-------------------------+---------------------------------------------------+


‚úÖ puertos principales de redes:
******************************************************************
# para escanear todos los puertos: nmap -p- <ip-a-escanear>
+--------+-----------+---------------------------+
| Puerto | Protocolo | Servicio com√∫n            |
+--------+-----------+---------------------------+
| 20     | TCP       | FTP data transfer         |
| 21     | TCP       | FTP control               |
| 22     | TCP       | SSH                       |
| 23     | TCP       | Telnet                    |
| 25     | TCP       | SMTP                      |
| 53     | TCP/UDP   | DNS                       |
| 67     | UDP       | DHCP server               |
| 68     | UDP       | DHCP client               |
| 80     | TCP       | HTTP                      |
| 110    | TCP       | POP3                      |
| 123    | UDP       | NTP                       |
| 143    | TCP       | IMAP                      |
| 161    | UDP       | SNMP                      |
| 194    | TCP       | IRC                       |
| 443    | TCP       | HTTPS                     |
| 445    | TCP       | SMB (Windows file share)  |
| 514    | UDP       | Syslog                    |
| 993    | TCP       | IMAPS                     |
| 995    | TCP       | POP3S                     |
| 1723   | TCP       | PPTP VPN                  |
| 3306   | TCP       | MySQL                     |
| 3389   | TCP       | RDP                       |
| 5060   | UDP/TCP   | SIP (VoIP signaling)      |
| 5432   | TCP       | PostgreSQL                |
| 5900   | TCP       | VNC                       |
| 8080   | TCP       | HTTP alternative / proxy  |
+--------+-----------+---------------------------+


=========================================================================================================================
[‚úÖ IP > Firewall]:

## sistema de input, output y forward

Cadena (Chain)             ¬øQu√© filtra?	                              Ejemplo de uso
-------------------------------------------------------------------------------------------------------------------------
input                      Tr√°fico destinado al router                Permitir SSH/Winbox/ICMP al router.
forward                    Tr√°fico que pasa a trav√©s del router       Filtrar tr√°fico LAN ‚Üí WAN / WAN ‚Üí LAN.                    # no es para la m√°quina local, sino que el firewall est√° actuando como router o puente, reenviando paquetes entre redes.
output                     Tr√°fico generado por el router             Controlar actualizaciones o pings del propio router
                                                                      -(se suele utilizar para bloquear actualizaciones).


‚úÖ Ejemplos r√°pidos:
******************************************************************
‚úÖ 1. INPUT ‚Üí Tr√°fico AL router (servicios del router)
üìå Ejemplo 1: Permitir acceso SSH al router desde una IP concreta
üìå Ejemplo 2: Permitir Winbox desde red local
üí°üì° Es el que utilizo para permitir servicios al mikrotik 

‚úÖ 2. FORWARD ‚Üí Tr√°fico que PASA a trav√©s del router
üìå Ejemplo 1: Permitir que LAN navegue por Internet
üìå Ejemplo 2: Bloquear que LAN acceda a una IP espec√≠fica
üí°üß± Es el que se utiliza como firewall de servicios en red 

‚úÖ 3. OUTPUT ‚Üí Tr√°fico generado POR el router
üìå Ejemplo 1: Bloquear que el router haga ping a Internet
üìå Ejemplo 2: Bloquear actualizaciones del router
üí° Es el menos utilizado, para permitir desde el mikrotik


‚úÖ ejemplo de uso:
******************************************************************
Usuario ‚Üí Router     # input
Router ‚Üí Usuario     # output
Red ‚Üí Router ‚Üí Red   # forward


‚úÖ acciones (targets) m√°s comunes que puedes aplicar a las reglas:
******************************************************************
# m√°s usadas:
accept:                     Permite el paquete (equivalente a ACCEPT).
drop:                       Descarta el paquete sin respuesta (equivalente a DROP).
reject:                     Bloquea y env√≠a respuesta ICMP o TCP reset (equivalente a REJECT).

# otras opciones:
log:                        Registra el paquete en logs.
return:                     Sale de la regla o cadena actual.
passthrough:                Deja continuar evaluaci√≥n en siguientes reglas (similar a RETURN en iptables).
nat (src-nat, dst-nat):     Traducci√≥n de IP origen/destino (equivalente a SNAT/DNAT).
mark:                       Marca paquetes para procesamiento posterior (similar a QUEUE o mangle en iptables).


‚úÖ punto de inicio o destino del tr√°fico:
******************************************************************
# definir origen o/y el destino del paquete
src-address: IP de origen del paquete (desde d√≥nde viene).
dst-address: IP de destino del paquete (a d√≥nde va).

# las listas son enumeraciones varias de ips y se pueden crear desde menu ‚Üí IP ‚Üí Firewall ‚Üí Address Lists
src-address-list: Lista de direcciones IP origen predefinidas por mi.
dst-address-list: Lista de direcciones IP destino predefinidas por mi.

# para comprobar los puertos de una ip, desde otro servidor linux externo "nmap -p- <ip-a-escanear>"
src-port: Puerto de origen del paquete (desde qu√© puerto sale, √∫til para TCP/UDP).
dst-port: Puerto de destino del paquete (hacia qu√© puerto se dirige, √∫til para TCP/UDP).

# tambi√©n se puede validar por interface, las interfaces se crean en menu ‚Üí interfaces
in-interface: Interfaz de entrada por la que llega el paquete (por d√≥nde entra al router).
out-interface: Interfaz de salida por la que se env√≠a el paquete (por d√≥nde sale del router).


‚úÖ orden para agregar filas del firewall:
******************************************************************
# para agregar reglas del firewall se sigue el siguiente orden
#	- primero se acepta toda la red
#	- luego se van denegando los servicios, protocolos o redes que quiera aislar
# en el comentario, es preferible porner un titulo simple en may√∫sculas de la referencia de la regla, para interpretarlas m√°s r√°pidamente

Un ejemplo con una vlan 53: 
-----------------------------------------------------------------------------------------------------
## no hace falta permitir el tr√°fico dentro de la misma vlan ya que no pasa por el router cuando se trata de la misma vlan, cada interface la tengo asignada en una vlan
## EJEMPLO - Permirimos todo el tr√°fico a un servidor
Chain:FORWARD   Src. Address:<IP-SERVIDOR> 	Action:ACCEPT 
## EJEMPLO - Permitimos gestion de los puertos necesarios de una lista de IT que enumera varias ips hacia la vlan
Chain:FORWARD 	Src. Address List:<LIST-IT> Protocol:TCP  Dst-Prot:53,80,5010  	Out. Interface:53 	Action:ACCEPT  
## EJEMPLO - Permitimos gestion de los puertos necesarios de una ip hacia la vlan
Chain:FORWARD 	Src Address:<IP-MANUEL> Protocol:TCP  Dst-Prot:53,80,5010  	Out. Interface:53 	Action:ACCEPT  
## EJEMPLO - Bloquear acceso desde otras vlanes hacia la vlan-53 con monitorizaci√≥n de log
Chain:FORWARD 	In. Interface:[!]53 	Out. Interface:53 	Action:DROP 	Log[x]
-----------------------------------------------------------------------------------------------------


‚úÖ connection-state:
******************************************************************
# En MikroTik, connection-state clasifica el estado del paquete en relaci√≥n con conexiones previas. 
new:				Primer paquete de una nueva conexi√≥n (ej.: primer SYN de TCP).
established:		Paquete perteneciente a una conexi√≥n ya aceptada y activa.
related:			Nuevo flujo asociado a una conexi√≥n existente (ej.: FTP, ICMP error).
invalid:			Paquete que no pertenece a ninguna conexi√≥n v√°lida (puede ser corrupto).
untracked:			Paquete no inspeccionado por el conntrack (tracking deshabilitado).


‚úÖ jump-chain:
******************************************************************
## Un Jump-Chain lo que hace es algo as√≠ como un Go-To, es decir te lleva a otras
## esto es √∫til cuando quieres que salte otras reglas que por ejemplo cancelen la lectura
## para crear un jump-chain se hace de la siguiente manera, dentro de la regla a la que quieres saltar 

# le asigno un nombre en vez de selecionar forward, input u output, as√≠ como tantas reglas de salto quiera que ejecute al iniciarse el salto
<regla-asaltada> > General > Chain: <nombre-jump-chain>

# luego creo la regla inicializadora del salto, en el caso de ejecutarse es la que va a dar luegar a iniciarse el salto (en caso de que no se inicialice no se ejecutar√° el salto y la lectura ser√° mucho m√°s r√°pida)
<regla-inicializadora-del-salto> > Action > Jump Target > (selecciono el jump-chain que he creado anteriormente)

# es un poco rara la configuraci√≥n porque primero se crea hacia donde se va a salta y luego el salto
# esta forma de trabajar que no es com√∫n verla, pero a veces es la √∫nica salida, funciona mucho m√°s fluida y m√°s r√°pida el mikrotik lo que requiere un menor rendimiento



=========================================================================================================================
=========================================================================================================================
				 		- EJERCICIOS - 
=========================================================================================================================
=========================================================================================================================
[‚úÖ Configuraci√≥n de Mikoritk]:
[üìå Ejercicio 1 ¬∑ (red b√°sica) conseguir internet]:

MMM      MMM       KKK                          TTTTTTTTTTT      KKK
MMMM    MMMM       KKK                          TTTTTTTTTTT      KKK
MMM MMMM MMM  III  KKK  KKK  RRRRRR     OOOOOO      TTT     III  KKK  KKK
MMM  MM  MMM  III  KKKKK     RRR  RRR  OOO  OOO     TTT     III  KKKKK
MMM      MMM  III  KKK KKK   RRRRRR    OOO  OOO     TTT     III  KKK KKK
MMM      MMM  III  KKK  KKK  RRR  RRR   OOOOOO      TTT     III  KKK  KKK

# resetear mikrotick
System - reset configuration - chequear las  siguientes opciones:
	- No default configuration
  - Do not buckup

# Instalar √∫ltima versi√≥n 
System -> Packages -> Check For Updates  -> (Seleccionamos la estable) Download&Install

# explicaci√≥n WAN/LAN
# Internet (89.345.34.22) <---- WAN ----> [MikroTik] <---- LAN ----> PC (192.168.1.23)

# -----Bridge-----
# Creo un bridge para enlazar todos los eth de salida porque son 3, para eso vamos a brige (+) y lo nombro bridge_LAN
# Luego vamos a la pesta√±a de (Ports) y asociamos los puertos eth salientes (LAN) con el bridge
[eth2, eth3 y eth4]

# ------interfefaces----- (bocas f√≠sicos)
# se genera autom√°ticamente lo que vamos creando
# aqu√≠ veremos los puertos fisicos por ejemplo como tenemos 4 ether uno de entrada y tres de salida veremos los cuatro


# ------IP--------
Luego vamos a ip > address y agregamos en WAN la IP de entrada y en LAN la ip de salida (asociada al bridge, es decir, en LAN el bridge):
WAN :           ADDRESS >  192.168.0.220/24       NETWORK > 192.168.0.0        INTERFACE > WAN
bridge_LAN :    ADDRESS >  172.16.0.1/24          NETWORK > 172.16.0.0         INTERFACE > bridge_LAN


------DNS--------
# Esta DNS va a ser la del Mikrotik
Luego vamos a ip > DNS, para darle un DNS, cambiamos en el apartado de Servers la DNS como por ejemplo 8.8.8.8


# CONSEGUIR INTERNET: 
# *********************************
# -----NAT-----
Para conseguir NAT hay que configurar el NAT de la siguiente forma, vamos a IP > Firewall > (+)
En Chain la cambio a "srcnat", en out.interface le configuro la WAN que en mi caso es (ether1)
y en la casilla action lo cambio a "masquerade", una vez hechos los cambios lo guardo. 
-----------------------------------------------------------------------------------------------
# NAT masquerade (enmascarada) 
es una t√©cnica utilizada en redes de computadoras para permitir que m√∫ltiples dispositivos en una red local compartan una √∫nica direcci√≥n IP p√∫blica para acceder a Internet.
-----------------------------------------------------------------------------------------------

# -----AGREGAR GATEWAY-----
Me dirijo a IP > Routes > (+). 
Una vez aqui la dist.address la dejo en 0.0.0.0/0
En el Gateway le configuro la puerta de enlace de la WAN (192.168.0.1)


[üìå Ejercicio 2 ¬∑ configurar DHCP]:
# -------POOL------
# Primero configuro el Pool que sirve para poner un varemo de IPs con las que quiero trabajar: 
# Este varemo va a servir solo para asignar las IP din√°micas las IP est√°ticas las vamos a poder coger fuera de ese varemo.
IP > Pool > (+)
le doy un nombre que en mi caso es > dhcp_pool()
y seleccionamos el baremo de IPs que en mi caso es (18 ips) > 172.16.0.2-172.16.0.20

# -------DHCP SERVER------
IP > DHCP Server > (+)
elegimos el bridge que hemos creado en el primer proyecto donde conectamos todas nuestras redes LAN: interface > bridge_LAN
como tengo todo bien configurado le doy a siguiente en todo excepto la parte del tiempo que la he cambiado a 10 en vez de a 30, (este va a ser el tiempo en el que va a refrescar la IP din√°mica)
y en Address Pool selecciono el Pool que he creado anteriormente > dhcp_pool()

+ rellenar la parte de network

# -------DHCP CLIENT------ -> (No hay que hacerlo si nuestro router esta configurado a otro porque la IP se asigna autom√°ticamente).
Como mi red sobre la que ya he trabajado recibo una IP autom√°ticamente de la red del trabajo de otro router, no es necesario agregar el DHCP client 
ya que es para recoger la IP principal de salida. Como de recoger esta se√±al se encarga otro router al que yo estoy conectado en DHCP client se deja en blanco.

En el caso de que tendr√≠a que hacerlo: me dirijo a DHCP Client y le doy a (+), y agrego la interface de la WAN que en mi caso es la ethr1

# -------DNS-------
Vamos a DHCP Server -> Networks, y modificamos el DNS Server para modificar el DNS de las IP din√°micas 



